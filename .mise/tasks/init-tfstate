#!/usr/bin/env bash

#MISE description="Init OpenTofu S3 backend (create bucket, enable versioning/encryption/tags)"
#
#USAGE flag "--region <region>" help="AWS region for the bucket" {
#USAGE   default "us-west-2"
#USAGE }
#USAGE flag "--bucket <name>" help="S3 bucket name for terraform state" {
#USAGE   default "slipstream-tofu-state"
#USAGE }

set -euo pipefail

REGION="${usage_region:-us-west-2}"
BUCKET="${usage_bucket:-slipstream-tofu-state}"

echo "Initializing S3 bucket '$BUCKET' in region '$REGION' (native S3 lockfile, no DynamoDB)..."

if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
  echo "Bucket already exists."
else
  if [ "$REGION" = "us-east-1" ]; then
    aws s3api create-bucket --bucket "$BUCKET"
  else
    aws s3api create-bucket --bucket "$BUCKET" \
      --create-bucket-configuration LocationConstraint="$REGION"
  fi
  echo "Created bucket."
fi

aws s3api put-public-access-block \
  --bucket "$BUCKET" \
  --public-access-block-configuration BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true

aws s3api put-bucket-versioning \
  --bucket "$BUCKET" \
  --versioning-configuration Status=Enabled

aws s3api put-bucket-encryption \
  --bucket "$BUCKET" \
  --server-side-encryption-configuration '{
    "Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]
  }'

aws s3api put-bucket-tagging \
  --bucket "$BUCKET" \
  --tagging 'TagSet=[{Key=Name,Value=terraform-state},{Key=Purpose,Value=infra}]'


echo "Verification:"
aws s3api get-bucket-versioning --bucket "$BUCKET" | jq -r '.'
aws s3api get-bucket-encryption --bucket "$BUCKET" | jq -r '.'
echo "Done."
